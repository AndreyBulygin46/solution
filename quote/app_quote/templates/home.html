{% extends "base.html" %}
{% block title %}–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞{% endblock %}

{% block content %}
  {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <div class="alert {{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="quote-card">
    {% if no_quotes_message %}
      <p>{{ no_quotes_message }}</p>
    {% else %}
      <p>"{{ quote.text }}"</p>
      <p>–ò—Å—Ç–æ—á–Ω–∏–∫: {{ quote.source }}</p>
      <p class="views">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã: {{ view_count }}</p>
      <p class="author">–î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ—Ä–æ–º: {{ author }}</p>
      <p class="time">–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: {{ create_at }}</p>
      <p>
        üëç <span id="like-count">{{ like_count }}</span> |
        üëé <span id="dislike-count">{{ dislike_count }}</span>
      </p>

      {% if user.is_authenticated %}
        <form id="vote-form" method="post">
          {% csrf_token %}
          <input type="hidden" name="quote_id" value="{{ quote.id }}">
          <input type="hidden" name="vote" id="vote-value">
          <button
            type="submit"
            class="vote-btn"
            data-vote="like"
            {% if has_voted and user_vote %}disabled{% endif %}
          >
            üëç –õ–∞–π–∫
          </button>
          <button
            type="submit"
            class="vote-btn"
            data-vote="dislike"
            {% if has_voted and not user_vote %}disabled{% endif %}
          >
            üëé –î–∏–∑–ª–∞–π–∫
          </button>
        </form>
      {% endif %}

      {% if has_voted %}
        <p style="color: red;">–í—ã —É–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏</p>
      {% endif %}

      {% if user.is_authenticated and user == quote.author %}
        <form action="{% url 'delete_quote' quote.id %}" method="post">
          {% csrf_token %}
          <button
            type="submit"
            onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ü–∏—Ç–∞—Ç—É?')"
          >
            –£–¥–∞–ª–∏—Ç—å —Ü–∏—Ç–∞—Ç—É
          </button>
        </form>
      {% endif %}
    {% endif %}
  </div>

  <script>

    document.querySelectorAll('.vote-btn').forEach(button => {
      button.addEventListener('click', function() {
        const voteValue = this.getAttribute('data-vote');
        document.getElementById('vote-value').value = voteValue;
      });
    });

    document.getElementById('vote-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = this;
      const formData = new FormData(form);

      fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('like-count').textContent = data.like_count;
        document.getElementById('dislike-count').textContent = data.dislike_count;
        document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = true);

        if (data.message) {
          alert(data.message);
        }
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
      });
    });
  </script>
{% endblock %}
